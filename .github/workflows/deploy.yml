# å®šä¹‰å·¥ä½œæµ
name: Auto Deploy

# è®¾ç½®è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç è¢«pushåˆ°mainåˆ†æ”¯è§¦å‘
on:
  push:
    branches:
      - main

# å®šä¹‰ä¸€ä¸ªjobï¼šå¯åŠ¨ä¸€ä¸ªå«deployçš„ä»»åŠ¡
jobs:
  deploy:
    runs-on: ubuntu-latest

# ä½¿ç”¨ GitHub çš„å®˜æ–¹æ’ä»¶ï¼šæ‹‰å–æäº¤çš„æœ€æ–°ä»£ç 
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

# ä½¿ç”¨ GitHub æä¾›çš„ Secretsï¼ˆé¢„å…ˆä¿å­˜çš„æœåŠ¡å™¨ SSH ç§é’¥ï¼‰ï¼Œå¯åŠ¨ä¸€ä¸ª SSH-agentï¼Œè®©åé¢çš„ ssh å‘½ä»¤å¯ä»¥å®‰å…¨ç™»å½•æœåŠ¡å™¨
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

# ç™»å½•æœåŠ¡å™¨å¹¶éƒ¨ç½²ï¼Œæ¸…é™¤ä»»ä½•è¢«å ç”¨çš„80ç«¯å£ï¼Œå†è¿›è¡Œæ‹‰å–ï¼ŒåŒæ—¶é”€é™¤æ—§å®¹å™¨ï¼Œå»ºç«‹æ–°å®¹å™¨
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@43.134.70.241 << 'EOF'
            echo "--- ğŸ§¹ Cleaning up port 80..."
            sudo systemctl stop nginx || true
            sudo systemctl disable nginx || true
            sudo pkill nginx || true
            echo "--- ğŸ” Check who is still using port 80 (after clean-up)"
            sudo lsof -iTCP:80 -sTCP:LISTEN || true
            echo "--- ğŸ“ Deploying project"
            cd ~/flask-mega
            git pull origin main
            docker compose down --remove-orphans
            docker compose build --no-cache
            docker compose up -d
          EOF
